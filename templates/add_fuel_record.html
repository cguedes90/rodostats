{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-gas-pump"></i> Novo Abastecimento - {{ vehicle.name }}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="date" class="form-label">Data</label>
                                    <input type="date" class="form-control" id="date" name="date" required 
                                           value="{{ current_date }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="odometer" class="form-label">Odômetro (km)</label>
                                    <input type="number" step="0.1" class="form-control" id="odometer" name="odometer" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="liters" class="form-label">Litros</label>
                                    <input type="number" step="0.01" class="form-control" id="liters" name="liters" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="price_per_liter" class="form-label">Preço por Litro (R$)</label>
                                    <input type="number" step="0.001" class="form-control" id="price_per_liter" name="price_per_liter" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="total_cost" class="form-label">Total (R$)</label>
                                    <input type="number" step="0.01" class="form-control" id="total_cost" name="total_cost" required>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-calculator"></i> Preencha 2 dos 3 campos (Litros, Preço/L, Total) e o terceiro será calculado automaticamente
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="fuel_type" class="form-label">Tipo de Combustível</label>
                                    <select class="form-control" id="fuel_type" name="fuel_type">
                                        <option value="gasoline" {% if vehicle.fuel_type == 'gasoline' %}selected{% endif %}>Gasolina</option>
                                        <option value="ethanol" {% if vehicle.fuel_type == 'ethanol' %}selected{% endif %}>Etanol</option>
                                        <option value="diesel" {% if vehicle.fuel_type == 'diesel' %}selected{% endif %}>Diesel</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="gas_station" class="form-label">Posto de Combustível</label>
                            <input type="text" class="form-control" id="gas_station" name="gas_station">
                        </div>

                        <div class="mb-3">
                            <label for="receipt_image" class="form-label">Tire uma foto do cupom fiscal e/ou da bomba de combustível</label>
                            <input type="file" class="form-control" id="receipt_image" name="receipt_image" accept="image/*">
                            <small class="form-text text-muted">
                                <i class="fas fa-camera"></i> Tire uma foto do cupom fiscal ou da bomba de combustível para preenchimento automático dos dados com IA
                            </small>
                            <div id="imagePreview" class="mt-2" style="display: none;">
                                <img id="previewImage" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-primary" id="processImage">
                                        <i class="fas fa-robot"></i> Processar com IA
                                    </button>
                                    <button type="button" class="btn btn-sm btn-secondary" id="clearImage">
                                        <i class="fas fa-times"></i> Remover
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Observações</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('vehicle_detail', vehicle_id=vehicle.id) }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Salvar Abastecimento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Sistema inteligente de cálculo automático
// Calcula qualquer campo baseado nos outros dois preenchidos

// Usar delay para evitar cálculos prematuros enquanto digitando
let calculateTimeout;

function debouncedCalculate() {
    clearTimeout(calculateTimeout);
    calculateTimeout = setTimeout(smartCalculate, 300); // 300ms delay
}

document.getElementById('liters').addEventListener('input', debouncedCalculate);
document.getElementById('price_per_liter').addEventListener('input', debouncedCalculate);
document.getElementById('total_cost').addEventListener('input', debouncedCalculate);

function smartCalculate() {
    // Converter vírgula para ponto para cálculos corretos
    const litersRaw = document.getElementById('liters').value;
    const priceRaw = document.getElementById('price_per_liter').value;
    const totalRaw = document.getElementById('total_cost').value;
    
    const liters = parseFloat(litersRaw.replace(',', '.')) || 0;
    const pricePerLiter = parseFloat(priceRaw.replace(',', '.')) || 0;
    const totalCost = parseFloat(totalRaw.replace(',', '.')) || 0;
    
    // Debug - remover depois de testar
    console.log('Debug smartCalculate:', {
        litersRaw, priceRaw, totalRaw,
        liters, pricePerLiter, totalCost
    });
    
    // Contar quantos campos estão preenchidos (> 0)
    const filledFields = [liters > 0, pricePerLiter > 0, totalCost > 0].filter(Boolean).length;
    
    // Se temos exatamente 2 campos preenchidos, calcular o terceiro
    if (filledFields === 2) {
        
        // Cenário 1: Temos Litros + Preço/Litro → Calcular Total
        if (liters > 0 && pricePerLiter > 0 && totalCost === 0) {
            const calculatedTotal = (liters * pricePerLiter).toFixed(2);
            console.log('Calculando total:', liters, '*', pricePerLiter, '=', calculatedTotal);
            document.getElementById('total_cost').value = calculatedTotal;
        }
        
        // Cenário 2: Temos Litros + Total → Calcular Preço/Litro
        else if (liters > 0 && totalCost > 0 && pricePerLiter === 0) {
            const calculatedPrice = (totalCost / liters).toFixed(3);
            console.log('Calculando preço:', totalCost, '/', liters, '=', calculatedPrice);
            document.getElementById('price_per_liter').value = calculatedPrice;
        }
        
        // Cenário 3: Temos Preço/Litro + Total → Calcular Litros
        else if (pricePerLiter > 0 && totalCost >= 10 && liters === 0) { // Total >= 10 para evitar cálculos prematuros
            const calculatedLiters = (totalCost / pricePerLiter).toFixed(2);
            console.log('Calculando litros:', totalCost, '/', pricePerLiter, '=', calculatedLiters);
            document.getElementById('liters').value = calculatedLiters;
        }
    }
}

// Função para recalcular (usada pela IA) - mantém compatibilidade
function calculateTotal() {
    smartCalculate();
}

// Adicionar dicas visuais nos campos
document.addEventListener('DOMContentLoaded', function() {
    const fields = ['liters', 'price_per_liter', 'total_cost'];
    
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        
        field.addEventListener('focus', function() {
            // Destacar o campo em foco
            this.style.borderColor = '#007bff';
            this.style.boxShadow = '0 0 5px rgba(0,123,255,0.3)';
        });
        
        field.addEventListener('blur', function() {
            // Remover destaque
            this.style.borderColor = '';
            this.style.boxShadow = '';
        });
    });
});

// Funcionalidades da imagem
document.getElementById('receipt_image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImage').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

document.getElementById('clearImage').addEventListener('click', function() {
    document.getElementById('receipt_image').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('previewImage').src = '';
});

document.getElementById('processImage').addEventListener('click', function() {
    const fileInput = document.getElementById('receipt_image');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Por favor, selecione uma imagem primeiro.');
        return;
    }
    
    // Mostrar loading
    const processBtn = document.getElementById('processImage');
    const originalText = processBtn.innerHTML;
    processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
    processBtn.disabled = true;
    
    // Criar FormData
    const formData = new FormData();
    formData.append('image', file);
    
    // Enviar para API
    fetch('/api/process_receipt', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            Swal.fire({
                icon: 'error',
                title: 'Erro ao Processar',
                text: data.error,
                confirmButtonText: 'OK'
            });
        } else {
            // Array para controlar campos preenchidos
            const fieldsFilledList = [];

            // Função para animar campo preenchido
            function animateField(fieldId, value, fieldName) {
                const field = document.getElementById(fieldId);
                if (field && value) {
                    // Preencher valor
                    field.value = value;

                    // Adicionar animação de sucesso
                    field.classList.add('border-success', 'border-3');
                    field.style.transition = 'all 0.3s ease';
                    field.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.5)';

                    // Adicionar checkmark ao lado
                    const wrapper = field.parentElement;
                    let checkmark = wrapper.querySelector('.ai-filled-check');
                    if (!checkmark) {
                        checkmark = document.createElement('span');
                        checkmark.className = 'ai-filled-check';
                        checkmark.innerHTML = '<i class="fas fa-check-circle text-success ms-2"></i>';
                        checkmark.style.animation = 'fadeIn 0.5s';
                        wrapper.querySelector('label').appendChild(checkmark);
                    }

                    fieldsFilledList.push(fieldName);

                    // Remover destaque após 3 segundos
                    setTimeout(() => {
                        field.style.boxShadow = '';
                    }, 3000);
                }
            }

            // Preencher campos com animação
            if (data.data) animateField('date', data.data, 'Data');
            if (data.posto) animateField('gas_station', data.posto, 'Posto');
            if (data.litros) animateField('liters', data.litros, 'Litros');
            if (data.preco_litro) animateField('price_per_liter', data.preco_litro, 'Preço/L');
            if (data.total) animateField('total_cost', data.total, 'Total');

            if (data.combustivel) {
                const fuelMap = {
                    'gasolina': 'gasoline',
                    'etanol': 'ethanol',
                    'álcool': 'ethanol',
                    'diesel': 'diesel'
                };
                const fuelType = fuelMap[data.combustivel.toLowerCase()] || 'gasoline';
                animateField('fuel_type', fuelType, 'Combustível');
            }

            if (data.observacoes) animateField('notes', data.observacoes, 'Observações');

            // Recalcular total se necessário
            calculateTotal();

            // Mostrar toast de sucesso com lista de campos
            if (fieldsFilledList.length > 0) {
                Swal.fire({
                    icon: 'success',
                    title: 'IA Processou com Sucesso!',
                    html: `
                        <div class="text-start">
                            <p><strong>${fieldsFilledList.length} campo(s) preenchido(s) automaticamente:</strong></p>
                            <ul class="mb-0">
                                ${fieldsFilledList.map(field => `<li><i class="fas fa-check text-success me-1"></i>${field}</li>`).join('')}
                            </ul>
                        </div>
                    `,
                    confirmButtonText: 'Ótimo!',
                    timer: 5000,
                    timerProgressBar: true
                });
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'Nenhum Dado Extraído',
                    text: 'A IA não conseguiu extrair dados da imagem. Preencha manualmente.',
                    confirmButtonText: 'OK'
                });
            }
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao processar imagem. Tente novamente.');
    })
    .finally(() => {
        // Restaurar botão
        processBtn.innerHTML = originalText;
        processBtn.disabled = false;
    });
});
</script>
{% endblock %}
