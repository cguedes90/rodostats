{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-gas-pump"></i> Novo Abastecimento - {{ vehicle.name }}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="date" class="form-label">Data</label>
                                    <input type="date" class="form-control" id="date" name="date" required 
                                           value="{{ current_date }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="odometer" class="form-label">Odômetro (km)</label>
                                    <input type="number" step="0.1" class="form-control" id="odometer" name="odometer" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="liters" class="form-label">Litros</label>
                                    <input type="number" step="0.01" class="form-control" id="liters" name="liters" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="price_per_liter" class="form-label">Preço por Litro (R$)</label>
                                    <input type="number" step="0.001" class="form-control" id="price_per_liter" name="price_per_liter" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="total_cost" class="form-label">Total (R$)</label>
                                    <input type="number" step="0.01" class="form-control" id="total_cost" name="total_cost" required>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> Será calculado automaticamente quando você inserir litros e preço/litro
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="fuel_type" class="form-label">Tipo de Combustível</label>
                                    <select class="form-control" id="fuel_type" name="fuel_type">
                                        <option value="gasoline" {% if vehicle.fuel_type == 'gasoline' %}selected{% endif %}>Gasolina</option>
                                        <option value="ethanol" {% if vehicle.fuel_type == 'ethanol' %}selected{% endif %}>Etanol</option>
                                        <option value="diesel" {% if vehicle.fuel_type == 'diesel' %}selected{% endif %}>Diesel</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="gas_station" class="form-label">Posto de Combustível</label>
                            <input type="text" class="form-control" id="gas_station" name="gas_station">
                        </div>

                        <div class="mb-3">
                            <label for="receipt_image" class="form-label">Tire uma foto do cupom fiscal e/ou da bomba de combustível</label>
                            <input type="file" class="form-control" id="receipt_image" name="receipt_image" accept="image/*">
                            <small class="form-text text-muted">
                                <i class="fas fa-camera"></i> Tire uma foto do cupom fiscal ou da bomba de combustível para preenchimento automático dos dados com IA
                            </small>
                            <div id="imagePreview" class="mt-2" style="display: none;">
                                <img id="previewImage" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-primary" id="processImage">
                                        <i class="fas fa-robot"></i> Processar com IA
                                    </button>
                                    <button type="button" class="btn btn-sm btn-secondary" id="clearImage">
                                        <i class="fas fa-times"></i> Remover
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Observações</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('vehicle_detail', vehicle_id=vehicle.id) }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Salvar Abastecimento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Calcular campos automaticamente baseado no que foi preenchido
document.getElementById('liters').addEventListener('input', calculateFromLitersAndPrice);
document.getElementById('price_per_liter').addEventListener('input', calculateFromLitersAndPrice);
document.getElementById('total_cost').addEventListener('input', calculateFromTotalAndLiters);

let lastEditedField = null;

// Marcar qual campo foi editado por último
document.getElementById('liters').addEventListener('focus', () => lastEditedField = 'liters');
document.getElementById('price_per_liter').addEventListener('focus', () => lastEditedField = 'price_per_liter');
document.getElementById('total_cost').addEventListener('focus', () => lastEditedField = 'total_cost');

function calculateFromLitersAndPrice() {
    const liters = parseFloat(document.getElementById('liters').value) || 0;
    const pricePerLiter = parseFloat(document.getElementById('price_per_liter').value) || 0;
    
    if (liters > 0 && pricePerLiter > 0) {
        const total = (liters * pricePerLiter).toFixed(2);
        document.getElementById('total_cost').value = total;
    }
}

function calculateFromTotalAndLiters() {
    const liters = parseFloat(document.getElementById('liters').value) || 0;
    const totalCost = parseFloat(document.getElementById('total_cost').value) || 0;
    
    if (liters > 0 && totalCost > 0) {
        const pricePerLiter = (totalCost / liters).toFixed(3);
        document.getElementById('price_per_liter').value = pricePerLiter;
    }
}

// Função para recalcular baseada no contexto (usada pela IA)
function calculateTotal() {
    if (lastEditedField === 'total_cost') {
        calculateFromTotalAndLiters();
    } else {
        calculateFromLitersAndPrice();
    }
}

// Funcionalidades da imagem
document.getElementById('receipt_image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImage').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

document.getElementById('clearImage').addEventListener('click', function() {
    document.getElementById('receipt_image').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('previewImage').src = '';
});

document.getElementById('processImage').addEventListener('click', function() {
    const fileInput = document.getElementById('receipt_image');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Por favor, selecione uma imagem primeiro.');
        return;
    }
    
    // Mostrar loading
    const processBtn = document.getElementById('processImage');
    const originalText = processBtn.innerHTML;
    processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
    processBtn.disabled = true;
    
    // Criar FormData
    const formData = new FormData();
    formData.append('image', file);
    
    // Enviar para API
    fetch('/api/process_receipt', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Erro ao processar imagem: ' + data.error);
        } else {
            // Preencher campos automaticamente
            if (data.data) {
                document.getElementById('date').value = data.data;
            }
            if (data.posto) {
                document.getElementById('gas_station').value = data.posto;
            }
            if (data.litros) {
                document.getElementById('liters').value = data.litros;
            }
            if (data.preco_litro) {
                document.getElementById('price_per_liter').value = data.preco_litro;
            }
            if (data.total) {
                document.getElementById('total_cost').value = data.total;
            }
            if (data.combustivel) {
                const fuelMap = {
                    'gasolina': 'gasoline',
                    'etanol': 'ethanol',
                    'álcool': 'ethanol',
                    'diesel': 'diesel'
                };
                const fuelType = fuelMap[data.combustivel.toLowerCase()] || 'gasoline';
                document.getElementById('fuel_type').value = fuelType;
            }
            if (data.observacoes) {
                document.getElementById('notes').value = data.observacoes;
            }
            
            // Recalcular total se necessário
            calculateTotal();
            
            alert('Dados extraídos com sucesso da imagem!');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao processar imagem. Tente novamente.');
    })
    .finally(() => {
        // Restaurar botão
        processBtn.innerHTML = originalText;
        processBtn.disabled = false;
    });
});
</script>
{% endblock %}
