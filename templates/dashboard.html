{% extends "base.html" %}

{% block title %}Dashboard - FuelTracker Pro{% endblock %}

{% block content %}

<!-- Sistema de Boas-Vindas Inteligente -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card gradient-card border-0 shadow-lg">
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h2 class="mb-2">
                            <span id="greeting-icon"></span>
                            <span id="greeting-text"></span>, {{ current_user.name }}!
                        </h2>
                        <p class="text-light mb-3" id="welcome-message">
                            <i class="fas fa-circle-notch fa-spin me-2"></i>Carregando insights...
                        </p>

                        <!-- Notifica√ß√µes Importantes -->
                        <div id="important-notifications" class="mt-3">
                            <!-- Preenchido via JavaScript -->
                        </div>
                    </div>
                    <div class="col-lg-4 text-center">
                        <div class="metric-value text-white">R$ {{ "%.2f"|format(total_spent) }}</div>
                        <div class="text-light">Total Gasto no Per√≠odo</div>
                        <small class="text-light-emphasis">
                            <i class="fas fa-chart-line me-1"></i>
                            {{ recent_records|length }} abastecimentos registrados
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- A√ß√µes R√°pidas - DESTAQUE PRINCIPAL -->
<div class="row mb-4">
    <div class="col-12 mb-3">
        <h4 class="text-white">
            <i class="fas fa-bolt me-2 text-warning"></i>A√ß√µes R√°pidas
        </h4>
        <p class="text-light-emphasis small">O que voc√™ deseja fazer agora?</p>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <a href="{{ url_for('add_fuel') }}" class="text-decoration-none">
            <div class="card quick-action-card h-100 border-primary">
                <div class="card-body text-center p-4">
                    <div class="quick-action-icon mb-3">
                        <i class="fas fa-gas-pump fa-3x text-primary"></i>
                    </div>
                    <h5 class="text-white mb-2">Abastecer Agora</h5>
                    <p class="text-light-emphasis small mb-0">Registrar novo abastecimento</p>
                </div>
            </div>
        </a>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <a href="{{ url_for('maintenance_list') }}" class="text-decoration-none">
            <div class="card quick-action-card h-100 border-warning">
                <div class="card-body text-center p-4">
                    <div class="quick-action-icon mb-3">
                        <i class="fas fa-tools fa-3x text-warning"></i>
                    </div>
                    <h5 class="text-white mb-2">Manuten√ß√£o</h5>
                    <p class="text-light-emphasis small mb-0">Registrar manuten√ß√£o do ve√≠culo</p>
                </div>
            </div>
        </a>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <a href="{{ url_for('vehicles') }}" class="text-decoration-none">
            <div class="card quick-action-card h-100 border-success">
                <div class="card-body text-center p-4">
                    <div class="quick-action-icon mb-3">
                        <i class="fas fa-car fa-3x text-success"></i>
                    </div>
                    <h5 class="text-white mb-2">Minha Garagem</h5>
                    <p class="text-light-emphasis small mb-0">Ver e gerenciar ve√≠culos</p>
                </div>
            </div>
        </a>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <a href="{{ url_for('analytics') }}" class="text-decoration-none">
            <div class="card quick-action-card h-100 border-info">
                <div class="card-body text-center p-4">
                    <div class="quick-action-icon mb-3">
                        <i class="fas fa-chart-bar fa-3x text-info"></i>
                    </div>
                    <h5 class="text-white mb-2">Relat√≥rios</h5>
                    <p class="text-light-emphasis small mb-0">An√°lises e estat√≠sticas</p>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Resumo R√°pido - M√©tricas Essenciais -->
<div class="row mb-4">
    <div class="col-12 mb-3">
        <h5 class="text-white">
            <i class="fas fa-tachometer-alt me-2"></i>Resumo R√°pido
        </h5>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card metric-card glass-effect">
            <div class="card-body text-center">
                <div class="metric-value text-primary">{{ "%.1f"|format(total_liters) }}L</div>
                <div class="metric-label">Total Litros</div>
                <i class="fas fa-gas-pump fa-2x text-primary mt-2"></i>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card metric-card glass-effect">
            <div class="card-body text-center">
                <div class="metric-value text-warning">R$ {{ "%.3f"|format(avg_price) }}</div>
                <div class="metric-label">Pre√ßo M√©dio/L</div>
                <i class="fas fa-calculator fa-2x text-warning mt-2"></i>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card metric-card glass-effect">
            <div class="card-body text-center">
                <div class="metric-value text-success">{{ consumption_metrics.average_consumption }} km/L</div>
                <div class="metric-label">Consumo M√©dio</div>
                <i class="fas fa-leaf fa-2x text-success mt-2"></i>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card metric-card glass-effect">
            <div class="card-body text-center">
                <div class="metric-value text-info">{{ consumption_metrics.total_km }}</div>
                <div class="metric-label">KM Rodados</div>
                <i class="fas fa-road fa-2x text-info mt-2"></i>
            </div>
        </div>
    </div>
</div>

<!-- Insights Inteligentes - Compacto -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-brain me-2 text-primary"></i>
                    <span>Insights Inteligentes</span>
                    <small class="badge bg-primary ms-2">IA</small>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshAIInsights()">
                    <i class="fas fa-sync-alt me-1"></i>Atualizar
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Coach Inteligente -->
                    <div class="col-lg-4 mb-3">
                        <div class="card glass-effect border-primary h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-user-tie text-primary me-2"></i>
                                    <h6 class="card-title mb-0">Coach IA</h6>
                                </div>
                                <div id="ai-coach-message" class="text-light small">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        Analisando...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recomenda√ß√µes -->
                    <div class="col-lg-4 mb-3">
                        <div class="card glass-effect border-success h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-lightbulb text-success me-2"></i>
                                    <h6 class="card-title mb-0">Recomenda√ß√µes</h6>
                                </div>
                                <div id="ai-recommendations" class="text-light small">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm text-success me-2" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        Calculando...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- An√°lise de Tend√™ncias -->
                    <div class="col-lg-4 mb-3">
                        <div class="card glass-effect border-warning h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-chart-line text-warning me-2"></i>
                                    <h6 class="card-title mb-0">Tend√™ncias</h6>
                                </div>
                                <div id="ai-analysis" class="text-light small">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm text-warning me-2" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        Analisando...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- √öltimos Abastecimentos -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-list me-2"></i>√öltimos Abastecimentos
                </span>
                <div>
                    <button class="btn btn-outline-light btn-sm"
                            data-bs-toggle="collapse"
                            data-bs-target="#advancedFilters">
                        <i class="fas fa-filter me-1"></i>Filtros
                    </button>
                </div>
            </div>

            <!-- Filtros Avan√ßados (Colapsados) -->
            <div class="collapse" id="advancedFilters">
                <div class="card-body border-bottom">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label for="vehicle_id" class="form-label">Ve√≠culo</label>
                            <select class="form-select" id="vehicle_id" name="vehicle_id">
                                <option value="">Todos os ve√≠culos</option>
                                {% for vehicle in vehicles %}
                                    <option value="{{ vehicle.id }}"
                                            {% if selected_vehicle == vehicle.id %}selected{% endif %}>
                                        {{ vehicle.brand }} {{ vehicle.model }} ({{ vehicle.license_plate }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="days" class="form-label">Per√≠odo</label>
                            <select class="form-select" id="days" name="days">
                                <option value="">Todos os dados</option>
                                <option value="7" {% if selected_days == 7 %}selected{% endif %}>√öltimos 7 dias</option>
                                <option value="30" {% if selected_days == 30 %}selected{% endif %}>√öltimos 30 dias</option>
                                <option value="365" {% if selected_days == 365 %}selected{% endif %}>√öltimo ano</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search me-1"></i>Filtrar
                            </button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light">
                                <i class="fas fa-times me-1"></i>Limpar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card-body">
                {% if recent_records %}
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Ve√≠culo</th>
                                    <th>Combust√≠vel</th>
                                    <th>Litros</th>
                                    <th>Valor</th>
                                    <th>Pre√ßo/L</th>
                                    <th>KM</th>
                                    <th>Posto</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in recent_records[:10] %}
                                <tr>
                                    <td>{{ record.date.strftime('%d/%m/%Y') }}</td>
                                    <td>
                                        {% for vehicle in vehicles %}
                                            {% if vehicle.id == record.vehicle_id %}
                                                {{ vehicle.brand }} {{ vehicle.model }}
                                                <br><small class="text-light-emphasis">{{ vehicle.license_plate }}</small>
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <span class="badge {% if record.fuel_type == 'Gasolina Comum' %}bg-danger{% elif record.fuel_type == 'Etanol' %}bg-success{% else %}bg-secondary{% endif %}">
                                            {{ record.fuel_type }}
                                        </span>
                                    </td>
                                    <td>{{ "%.2f"|format(record.liters) }}L</td>
                                    <td>R$ {{ "%.2f"|format(record.total_cost) }}</td>
                                    <td>R$ {{ "%.3f"|format(record.total_cost / record.liters) }}</td>
                                    <td>
                                        {% if record.odometer %}
                                            {{ record.odometer }} km
                                        {% else %}
                                            <span class="text-light-emphasis">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.gas_station %}
                                            {{ record.gas_station }}
                                        {% else %}
                                            <span class="text-light-emphasis">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if recent_records|length > 10 %}
                    <div class="text-center mt-3">
                        <small class="text-light-emphasis">
                            Mostrando 10 de {{ recent_records|length }} registros.
                            <a href="{{ url_for('analytics') }}" class="text-info">Ver todos</a>
                        </small>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-gas-pump fa-3x text-light-emphasis mb-3"></i>
                        <h5 class="text-light">Nenhum abastecimento registrado ainda</h5>
                        <p class="text-light-emphasis">Comece registrando seu primeiro abastecimento!</p>
                        <a href="{{ url_for('vehicles') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Registrar Agora
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recursos Avan√ßados (Colapsados) -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header"
                 style="cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;"
                 data-bs-toggle="collapse"
                 data-bs-target="#advancedFeatures">
                <i class="fas fa-magic me-2"></i>
                <strong>Recursos Avan√ßados</strong>
                <small class="badge bg-light text-dark ms-2">Clique para expandir</small>
                <i class="fas fa-chevron-down float-end"></i>
            </div>
            <div class="collapse" id="advancedFeatures">
                <div class="card-body">
                    <!-- Comando de Voz -->
                    <div class="mb-4">
                        <h6><i class="fas fa-microphone me-2 text-primary"></i>Comando de Voz Inteligente</h6>
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <p class="small mb-2">
                                    <strong>Exemplos:</strong> "Abasteci R$ 80 de gasolina comum hoje" ‚Ä¢
                                    "Troquei o √≥leo, gastei R$ 150" ‚Ä¢ "Fiz 450km"
                                </p>
                                <div id="voiceStatus" class="text-info small mb-2"></div>
                                <div id="voiceTranscript" class="text-success small"></div>
                            </div>
                            <div class="col-md-4 text-center">
                                <button id="voiceButton" class="btn btn-primary btn-lg" onclick="startVoiceRecognition()">
                                    <i class="fas fa-microphone fa-2x"></i>
                                    <div class="small mt-1">Clique e Fale</div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Gr√°ficos -->
                    <div class="mb-4">
                        <h6><i class="fas fa-chart-pie me-2 text-success"></i>Visualiza√ß√µes</h6>
                        <div class="row">
                            <div class="col-lg-6 mb-3">
                                <div class="card glass-effect">
                                    <div class="card-header">Gastos por Combust√≠vel</div>
                                    <div class="card-body d-flex justify-content-center">
                                        <div style="position: relative; width: 250px; height: 250px;">
                                            <canvas id="monthlyChart" width="250" height="250"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-3">
                                <div class="card glass-effect">
                                    <div class="card-header">Volume por Combust√≠vel</div>
                                    <div class="card-body d-flex justify-content-center">
                                        <div style="position: relative; width: 250px; height: 250px;">
                                            <canvas id="fuelChart" width="250" height="250"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Ferramentas IA -->
                    <div>
                        <h6><i class="fas fa-robot me-2 text-warning"></i>Ferramentas de IA</h6>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-primary w-100" onclick="generateAIReport()">
                                    <i class="fas fa-file-alt me-1"></i>Gerar Relat√≥rio Completo
                                </button>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-info w-100" onclick="showRegionalAnalysis()">
                                    <i class="fas fa-map me-1"></i>An√°lise Regional
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// =================================================================================
// SISTEMA DE BOAS-VINDAS INTELIGENTE
// =================================================================================

function updateGreeting() {
    const now = new Date();
    const hour = now.getHours();
    const greetingIcon = document.getElementById('greeting-icon');
    const greetingText = document.getElementById('greeting-text');

    if (hour >= 5 && hour < 12) {
        greetingIcon.innerHTML = '<i class="fas fa-sun text-warning me-2"></i>';
        greetingText.textContent = 'Bom dia';
    } else if (hour >= 12 && hour < 18) {
        greetingIcon.innerHTML = '<i class="fas fa-cloud-sun text-info me-2"></i>';
        greetingText.textContent = 'Boa tarde';
    } else {
        greetingIcon.innerHTML = '<i class="fas fa-moon text-primary me-2"></i>';
        greetingText.textContent = 'Boa noite';
    }
}

function generateWelcomeMessage() {
    const messages = [
        "Aqui est√° um resumo das suas √∫ltimas atividades.",
        "Pronto para economizar ainda mais hoje?",
        "Seus dados est√£o sendo analisados pela nossa IA.",
        "Acompanhe seus gastos e otimize seu combust√≠vel!",
        "Gerenciar seus ve√≠culos nunca foi t√£o f√°cil."
    ];

    const totalRecords = {{ recent_records|length }};
    const totalSpent = {{ total_spent }};

    let customMessage = "";

    if (totalRecords === 0) {
        customMessage = "Comece registrando seu primeiro abastecimento! √â r√°pido e f√°cil.";
    } else if (totalRecords < 5) {
        customMessage = `Voc√™ tem ${totalRecords} registro(s). Continue assim para ter an√°lises mais precisas!`;
    } else if (totalSpent > 1000) {
        customMessage = `J√° foram registrados R$ ${totalSpent.toFixed(2)} em abastecimentos. Veja suas economias nos insights abaixo!`;
    } else {
        customMessage = messages[Math.floor(Math.random() * messages.length)];
    }

    document.getElementById('welcome-message').innerHTML = `
        <i class="fas fa-info-circle me-2"></i>${customMessage}
    `;
}

function loadImportantNotifications() {
    const notificationsDiv = document.getElementById('important-notifications');
    const notifications = [];

    // Verificar se tem poucos registros
    const totalRecords = {{ recent_records|length }};
    if (totalRecords < 3 && totalRecords > 0) {
        notifications.push({
            type: 'info',
            icon: 'fa-chart-line',
            message: 'Registre mais abastecimentos para insights mais precisos da IA!'
        });
    }

    // Verificar consumo m√©dio
    const avgConsumption = parseFloat('{{ consumption_metrics.average_consumption }}'.replace(',', '.'));
    if (avgConsumption > 0 && avgConsumption < 8) {
        notifications.push({
            type: 'warning',
            icon: 'fa-exclamation-triangle',
            message: `Consumo m√©dio baixo (${avgConsumption} km/L). Considere verificar pneus e filtros!`
        });
    } else if (avgConsumption > 15) {
        notifications.push({
            type: 'success',
            icon: 'fa-trophy',
            message: `Excelente! Seu consumo m√©dio est√° √≥timo: ${avgConsumption} km/L`
        });
    }

    // Verificar pre√ßo m√©dio
    const avgPrice = {{ avg_price }};
    if (avgPrice > 6.0) {
        notifications.push({
            type: 'warning',
            icon: 'fa-money-bill-wave',
            message: 'Pre√ßo m√©dio alto detectado. Use a an√°lise regional para encontrar postos mais baratos!'
        });
    }

    // Renderizar notifica√ß√µes
    if (notifications.length > 0) {
        notificationsDiv.innerHTML = notifications.map(notif => `
            <div class="alert alert-${notif.type} alert-dismissible fade show mb-2" role="alert">
                <i class="fas ${notif.icon} me-2"></i>
                <small>${notif.message}</small>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
            </div>
        `).join('');
    }
}

// Inicializar quando p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    updateGreeting();
    generateWelcomeMessage();
    loadImportantNotifications();
    loadAIInsights();
    checkVoiceSupport();

    // Mostrar notifica√ß√£o de nova vers√£o E FOR√áAR RELOAD
    const lastVersion = localStorage.getItem('app_version');
    const currentVersion = '{{ app_version }}';

    if (lastVersion && lastVersion !== currentVersion) {
        // Nova vers√£o detectada! For√ßar reload do cache
        console.log('[CACHE] Nova vers√£o detectada:', lastVersion, '->', currentVersion);

        // Limpar service worker cache se existir
        if ('caches' in window) {
            caches.keys().then(names => {
                names.forEach(name => caches.delete(name));
            });
        }

        setTimeout(() => {
            Swal.fire({
                icon: 'success',
                title: 'Nova Vers√£o Dispon√≠vel!',
                html: `
                    <div class="text-start">
                        <p><strong>RodoStats ${currentVersion}</strong> - Atualiza√ß√£o Completa! üéâ</p>
                        <ul class="small mb-0">
                            <li>üîí <strong>Seguran√ßa:</strong> Prote√ß√£o total de credenciais</li>
                            <li>‚ú® <strong>IA Melhorada:</strong> Feedback visual ao processar imagens</li>
                            <li>üì± <strong>Mobile First:</strong> Responsividade otimizada</li>
                            <li>üé® <strong>Cores:</strong> Sistema padronizado de status</li>
                            <li>üîó <strong>Atalhos:</strong> Links diretos para a√ß√µes</li>
                            <li>üß™ <strong>Testes:</strong> 11 testes automatizados</li>
                        </ul>
                        <p class="text-muted small mt-2">A p√°gina ser√° recarregada para aplicar as mudan√ßas...</p>
                    </div>
                `,
                confirmButtonText: 'Recarregar Agora',
                timer: 5000,
                timerProgressBar: true,
                width: '600px',
                willClose: () => {
                    // For√ßar hard reload ao fechar o alerta
                    window.location.reload(true);
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.reload(true);
                }
            });
        }, 1000);
    } else if (!lastVersion) {
        // Primeira visita - for√ßar reload limpo
        console.log('[CACHE] Primeira visita detectada, limpando cache...');
        if ('caches' in window) {
            caches.keys().then(names => {
                names.forEach(name => caches.delete(name));
            });
        }
    }

    // Salvar vers√£o atual
    localStorage.setItem('app_version', currentVersion);
});

// =================================================================================
// GR√ÅFICOS
// =================================================================================

const monthlyDataByFuel = {{ monthly_data_by_fuel | tojson }};
const fuelDistribution = {{ fuel_distribution | tojson }};

document.addEventListener('DOMContentLoaded', function() {
    // GR√ÅFICO 1: Gastos por Combust√≠vel
    const gastosCanvas = document.getElementById('monthlyChart');
    if (gastosCanvas) {
        let gastosData = { 'Gasolina': 0, 'Etanol': 0, 'Diesel': 0 };

        Object.values(monthlyDataByFuel || {}).forEach(monthData => {
            gastosData['Gasolina'] += (monthData['Gasolina Comum'] || 0);
            gastosData['Etanol'] += (monthData['Etanol'] || 0);
            gastosData['Diesel'] += (monthData['Diesel'] || 0);
        });

        const labels1 = [];
        const data1 = [];
        const colors1 = [];

        if (gastosData['Gasolina'] > 0) {
            labels1.push('Gasolina');
            data1.push(gastosData['Gasolina']);
            colors1.push('#dc3545');
        }
        if (gastosData['Etanol'] > 0) {
            labels1.push('Etanol');
            data1.push(gastosData['Etanol']);
            colors1.push('#28a745');
        }
        if (gastosData['Diesel'] > 0) {
            labels1.push('Diesel');
            data1.push(gastosData['Diesel']);
            colors1.push('#ffc107');
        }

        if (data1.length === 0) {
            labels1.push('Gasolina', 'Etanol');
            data1.push(150, 100);
            colors1.push('#dc3545', '#28a745');
        }

        new Chart(gastosCanvas.getContext('2d'), {
            type: 'pie',
            data: {
                labels: labels1,
                datasets: [{
                    data: data1,
                    backgroundColor: colors1,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#ffffff' } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': R$ ' + context.parsed.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }

    // GR√ÅFICO 2: Volume por Combust√≠vel
    const volumeCanvas = document.getElementById('fuelChart');
    if (volumeCanvas) {
        const labels2 = Object.keys(fuelDistribution || {});
        const data2 = Object.values(fuelDistribution || {});
        const colors2 = ['#dc3545', '#28a745', '#ffc107', '#17a2b8'];

        if (labels2.length === 0 || data2.every(val => val === 0)) {
            labels2.splice(0);
            data2.splice(0);
            labels2.push('Gasolina', 'Etanol');
            data2.push(120, 80);
        }

        new Chart(volumeCanvas.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: labels2,
                datasets: [{
                    data: data2,
                    backgroundColor: colors2.slice(0, labels2.length),
                    borderWidth: 2,
                    cutout: '50%'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#ffffff' } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed.toFixed(1) + 'L';
                            }
                        }
                    }
                }
            }
        });
    }
});

// =================================================================================
// INSIGHTS DE IA
// =================================================================================

function loadAIInsights() {
    loadCoachMessage();
    loadAIRecommendations();
    loadAIAnalysis();
}

function loadCoachMessage() {
    fetch('/api/ai/coach')
        .then(response => response.json())
        .then(data => {
            const element = document.getElementById('ai-coach-message');
            if (data.message) {
                element.innerHTML = `<i class="fas fa-comment-dots me-1"></i>${data.message}`;
            } else {
                element.innerHTML = `<small class="text-muted"><i class="fas fa-info-circle me-1"></i>IA temporariamente indispon√≠vel</small>`;
            }
        })
        .catch(error => {
            console.error('Erro ao carregar coach:', error);
            document.getElementById('ai-coach-message').innerHTML = `<small class="text-muted">Erro ao carregar</small>`;
        });
}

function loadAIRecommendations() {
    const params = new URLSearchParams({
        current_gas_price: '5.50',
        current_ethanol_price: '3.89'
    });

    fetch('/api/ai/recommendations?' + params.toString())
        .then(response => response.json())
        .then(data => {
            const element = document.getElementById('ai-recommendations');
            if (data.recommendations && data.recommendations.length > 0) {
                let html = '<div>';
                data.recommendations.slice(0, 2).forEach(rec => {
                    html += `<div class="mb-1"><i class="fas fa-check-circle me-1 text-success"></i>${rec}</div>`;
                });
                html += '</div>';
                element.innerHTML = html;
            } else {
                element.innerHTML = `<small class="text-muted">An√°lise indispon√≠vel</small>`;
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            document.getElementById('ai-recommendations').innerHTML = `<small class="text-muted">Erro</small>`;
        });
}

function loadAIAnalysis() {
    fetch('/api/ai/analyze')
        .then(response => response.json())
        .then(data => {
            const element = document.getElementById('ai-analysis');
            if (data.analysis && data.analysis.predictions) {
                const pred = data.analysis.predictions;
                element.innerHTML = `
                    <div><i class="fas fa-calendar me-1"></i>Pr√≥ximo m√™s: R$ ${pred.next_month_estimate}</div>
                    <div class="mt-1"><i class="fas fa-chart-line me-1"></i>${pred.trend_analysis}</div>
                `;
            } else {
                element.innerHTML = `<small class="text-muted">An√°lise indispon√≠vel</small>`;
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            document.getElementById('ai-analysis').innerHTML = `<small class="text-muted">Erro</small>`;
        });
}

function refreshAIInsights() {
    document.getElementById('ai-coach-message').innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"></div>';
    document.getElementById('ai-recommendations').innerHTML = '<div class="spinner-border spinner-border-sm text-success" role="status"></div>';
    document.getElementById('ai-analysis').innerHTML = '<div class="spinner-border spinner-border-sm text-warning" role="status"></div>';
    loadAIInsights();
}

// Ferramentas IA (mantidas do c√≥digo original)
function generateAIReport() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Gerando...';
    btn.disabled = true;

    fetch('/api/ai/report')
        .then(response => response.json())
        .then(data => {
            if (data.report) {
                showAIReportModal(data.report, data.data);
            } else {
                alert('Erro ao gerar relat√≥rio: ' + (data.error || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao gerar relat√≥rio. Tente novamente.');
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

function showRegionalAnalysis() {
    showCityInputModal();
}

function showCityInputModal() {
    const modalHtml = `
        <div class="modal fade" id="cityInputModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-map-marker-alt me-2"></i>An√°lise Regional</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="cityInput" class="form-label">Digite sua cidade:</label>
                            <input type="text" class="form-control" id="cityInput"
                                   placeholder="Ex: S√£o Paulo, Rio de Janeiro..."
                                   autocomplete="off">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Digite o nome da sua cidade
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="performRegionalAnalysis()">
                            <i class="fas fa-chart-line me-1"></i>Analisar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    const existingModal = document.getElementById('cityInputModal');
    if (existingModal) existingModal.remove();

    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('cityInputModal'));
    modal.show();

    document.getElementById('cityInputModal').addEventListener('shown.bs.modal', function () {
        document.getElementById('cityInput').focus();
    });
}

function performRegionalAnalysis() {
    const cityInput = document.getElementById('cityInput');
    const region = cityInput.value.trim() || 'Brasil';

    if (region.length < 2) {
        alert('Por favor, digite o nome de uma cidade.');
        return;
    }

    const inputModal = bootstrap.Modal.getInstance(document.getElementById('cityInputModal'));
    inputModal.hide();

    fetch(`/api/ai/regional?region=${encodeURIComponent(region)}`)
        .then(response => response.json())
        .then(data => {
            showRegionalModal(data.regional_analysis, data.user_data, region);
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao carregar an√°lise regional. Tente novamente.');
        });
}

function showAIReportModal(report, data) {
    const modalHtml = `
        <div class="modal fade" id="aiReportModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-file-alt me-2"></i>Relat√≥rio Inteligente</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-dark" style="max-height: 400px; overflow-y: auto;">
                            ${report ? report.replace(/\n/g, '<br>') : 'Relat√≥rio indispon√≠vel'}
                        </div>
                        <hr>
                        <small class="text-muted">
                            Gerado em ${new Date().toLocaleString('pt-BR')} |
                            ${data.total_records} registros
                        </small>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    const existingModal = document.getElementById('aiReportModal');
    if (existingModal) existingModal.remove();

    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('aiReportModal'));
    modal.show();
}

function showRegionalModal(analysis, userData, region) {
    alert('Funcionalidade de an√°lise regional em desenvolvimento. Regi√£o selecionada: ' + region);
}

// =================================================================================
// RECONHECIMENTO DE VOZ
// =================================================================================

let recognition = null;
let isListening = false;

function checkVoiceSupport() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        const statusEl = document.getElementById('voiceStatus');
        if (statusEl) {
            statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Navegador n√£o suporta voz.';
        }
        const btnEl = document.getElementById('voiceButton');
        if (btnEl) {
            btnEl.disabled = true;
        }
        return false;
    }
    return true;
}

function initVoiceRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();

    recognition.lang = 'pt-BR';
    recognition.continuous = false;
    recognition.interimResults = true;

    recognition.onstart = function() {
        isListening = true;
        document.getElementById('voiceStatus').innerHTML = '<i class="fas fa-microphone text-danger"></i> Escutando...';
        document.getElementById('voiceButton').innerHTML = '<i class="fas fa-stop fa-2x"></i><div class="small mt-1">Gravando...</div>';
        document.getElementById('voiceButton').classList.add('btn-danger');
        document.getElementById('voiceButton').classList.remove('btn-primary');
    };

    recognition.onresult = function(event) {
        const transcript = event.results[event.resultIndex][0].transcript;
        document.getElementById('voiceTranscript').innerHTML = '<strong>Voc√™ disse:</strong> "' + transcript + '"';

        if (event.results[event.resultIndex].isFinal) {
            processVoiceCommand(transcript);
        }
    };

    recognition.onerror = function(event) {
        resetVoiceButton();
        document.getElementById('voiceStatus').innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Erro no reconhecimento';
    };

    recognition.onend = function() {
        resetVoiceButton();
    };
}

function resetVoiceButton() {
    isListening = false;
    const statusEl = document.getElementById('voiceStatus');
    if (statusEl) statusEl.innerHTML = '';

    const btnEl = document.getElementById('voiceButton');
    if (btnEl) {
        btnEl.innerHTML = '<i class="fas fa-microphone fa-2x"></i><div class="small mt-1">Clique e Fale</div>';
        btnEl.classList.add('btn-primary');
        btnEl.classList.remove('btn-danger');
    }
}

function startVoiceRecognition() {
    if (!checkVoiceSupport()) return;

    if (isListening) {
        recognition.stop();
        return;
    }

    if (!recognition) {
        initVoiceRecognition();
    }

    document.getElementById('voiceTranscript').innerHTML = '';
    recognition.start();
}

async function processVoiceCommand(transcript) {
    try {
        document.getElementById('voiceStatus').innerHTML = '<i class="fas fa-brain text-info"></i> Processando...';

        const response = await fetch('/api/ai/voice-command', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ transcript: transcript })
        });

        const result = await response.json();

        if (result.success) {
            document.getElementById('voiceStatus').innerHTML = '<i class="fas fa-check-circle text-success"></i> ' + result.message;
            if (result.data_saved) {
                setTimeout(() => window.location.reload(), 2000);
            }
        } else {
            document.getElementById('voiceStatus').innerHTML = '<i class="fas fa-question-circle text-warning"></i> ' + result.message;
        }
    } catch (error) {
        console.error('Erro:', error);
        document.getElementById('voiceStatus').innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Erro ao processar';
    }
}

</script>

<style>
/* A√ß√µes R√°pidas - Cards Interativos */
.quick-action-card {
    background: rgba(255, 255, 255, 0.05);
    transition: all 0.3s ease;
    cursor: pointer;
    border: 2px solid transparent;
}

.quick-action-card:hover {
    transform: translateY(-5px);
    background: rgba(255, 255, 255, 0.1);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.quick-action-card:hover .quick-action-icon i {
    transform: scale(1.1);
}

.quick-action-icon i {
    transition: transform 0.3s ease;
}

/* Gradient Card para Welcome */
.gradient-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* Metric Cards */
.metric-card {
    transition: transform 0.2s ease;
}

.metric-card:hover {
    transform: translateY(-3px);
}

.glass-effect {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Collapse Icons */
[data-bs-toggle="collapse"] {
    cursor: pointer;
    transition: all 0.3s ease;
}

[data-bs-toggle="collapse"]:hover {
    background: rgba(255, 255, 255, 0.05);
}

/* Alerts personalizados */
.alert {
    border-left: 4px solid;
}

.alert-info {
    border-left-color: #17a2b8;
}

.alert-warning {
    border-left-color: #ffc107;
}

.alert-success {
    border-left-color: #28a745;
}

/* ===================================
   RESPONSIVIDADE MOBILE
   =================================== */

/* Tablets */
@media (max-width: 992px) {
    .quick-action-card {
        margin-bottom: 1rem;
    }
}

/* Mobile - Smartphones */
@media (max-width: 768px) {
    /* A√ß√µes r√°pidas - 2 colunas */
    .col-lg-3.col-md-6 {
        flex: 0 0 50%;
        max-width: 50%;
    }

    /* M√©tricas - 2 colunas */
    .metric-card {
        margin-bottom: 1rem;
    }

    /* Tabela responsiva */
    .table-responsive {
        font-size: 0.85rem;
    }

    /* Reduzir padding */
    .card-body {
        padding: 1rem;
    }

    /* Boas-vindas mais compacto */
    .gradient-card h2 {
        font-size: 1.5rem;
    }

    /* Esconder texto auxiliar em mobile */
    .text-light-emphasis.small {
        display: none;
    }
}

/* Mobile pequeno */
@media (max-width: 480px) {
    /* A√ß√µes r√°pidas - 1 coluna */
    .col-lg-3.col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
    }

    /* M√©tricas - 1 coluna */
    .col-lg-3.col-md-6.mb-3 {
        flex: 0 0 100%;
        max-width: 100%;
    }

    /* √çcones menores */
    .quick-action-icon i {
        font-size: 2.5rem !important;
    }

    /* T√≠tulos menores */
    h4 {
        font-size: 1.2rem;
    }

    h5 {
        font-size: 1rem;
    }

    /* Tabela - esconder colunas menos importantes */
    .table td:nth-child(7),
    .table th:nth-child(7),
    .table td:nth-child(8),
    .table th:nth-child(8) {
        display: none;
    }
}
</style>
{% endblock %}
