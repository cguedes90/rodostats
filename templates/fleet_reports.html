{% extends "base.html" %}

{% block title %}Relat贸rios - {{ fleet.company_name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="gradient-text mb-1">
                    <i class="fas fa-chart-line me-2"></i>Relat贸rios da Frota
                </h1>
                <p class="text-muted mb-0">{{ fleet.company_name }}</p>
            </div>
            <div>
                <a href="{{ url_for('fleet_dashboard') }}" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left me-1"></i>Voltar ao Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Configura莽茫o do Relat贸rio -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>Configurar Relat贸rio
                </h5>
            </div>
            <div class="card-body">
                <form id="reportForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="reportPeriod" class="form-label">Per铆odo de An谩lise</label>
                            <select class="form-select" id="reportPeriod" name="period">
                                <option value="7">ltimos 7 dias</option>
                                <option value="30" selected>ltimos 30 dias</option>
                                <option value="90">ltimos 90 dias</option>
                                <option value="365">ltimo ano</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="reportType" class="form-label">Formato do Relat贸rio</label>
                            <select class="form-select" id="reportType" name="type">
                                <option value="pdf">PDF Executivo</option>
                                <option value="excel">Planilha Excel</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" onclick="generateReport()">
                            <i class="fas fa-file-download me-1"></i>Gerar Relat贸rio
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="previewReport()">
                            <i class="fas fa-eye me-1"></i>Visualizar Preview
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Sobre os Relat贸rios
                </h5>
            </div>
            <div class="card-body">
                <h6> PDF Executivo</h6>
                <p class="small text-muted mb-3">Relat贸rio profissional com KPIs principais, gr谩ficos e ranking de efici锚ncia.</p>

                <h6> Planilha Excel</h6>
                <p class="small text-muted mb-3">Dados detalhados em m煤ltiplas abas: resumo, ve铆culos e hist贸rico completo.</p>

                <div class="alert alert-info small">
                    <i class="fas fa-lightbulb me-1"></i>
                    <strong>Dica:</strong> Use o preview para verificar os dados antes de gerar o relat贸rio completo.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview dos Dados -->
<div class="row" id="previewSection" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-eye me-2"></i>Preview dos Dados
                </h5>
            </div>
            <div class="card-body" id="previewContent">
                <!-- Conte煤do ser谩 carregado via JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Loading e Status -->
<div class="row">
    <div class="col-12">
        <div id="loadingAlert" class="alert alert-primary" style="display: none;">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span>Gerando relat贸rio... Aguarde um momento.</span>
            </div>
        </div>

        <div id="errorAlert" class="alert alert-danger" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="errorMessage">Erro ao gerar relat贸rio.</span>
        </div>
    </div>
</div>

<script>
// Fun莽玫es para gerar relat贸rios
function generateReport() {
    const form = document.getElementById('reportForm');
    const formData = new FormData(form);
    const params = new URLSearchParams(formData);

    showLoading(true);
    hideError();

    // Construir URL
    const url = '/fleet/generate_report?' + params.toString();

    // Criar link de download
    const link = document.createElement('a');
    link.href = url;
    link.download = true;
    link.style.display = 'none';

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Ocultar loading ap贸s um tempo
    setTimeout(() => {
        showLoading(false);
    }, 2000);
}

async function previewReport() {
    const form = document.getElementById('reportForm');
    const formData = new FormData(form);
    const params = new URLSearchParams(formData);

    showLoading(true, 'Carregando preview...');
    hideError();

    try {
        const response = await fetch('/api/fleet/report_preview?' + params.toString());
        const data = await response.json();

        if (data.success) {
            displayPreview(data);
            document.getElementById('previewSection').style.display = 'block';
        } else {
            showError(data.error || 'Erro ao carregar preview');
        }
    } catch (error) {
        console.error('Erro:', error);
        showError('Erro de conex茫o ao carregar preview');
    }

    showLoading(false);
}

function displayPreview(data) {
    const previewContent = document.getElementById('previewContent');

    const html = `
        <div class="row">
            <div class="col-md-6">
                <h6> Informa莽玫es do Relat贸rio</h6>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Empresa:</strong></td>
                        <td>${data.fleet_name}</td>
                    </tr>
                    <tr>
                        <td><strong>Per铆odo:</strong></td>
                        <td>${data.period_days} dias</td>
                    </tr>
                    <tr>
                        <td><strong>Gerado em:</strong></td>
                        <td>${new Date(data.generated_at).toLocaleString('pt-BR')}</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6> Indicadores Principais</h6>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Total de Ve铆culos:</strong></td>
                        <td>${data.stats.total_vehicles}</td>
                    </tr>
                    <tr>
                        <td><strong>Total Gasto:</strong></td>
                        <td>R$ ${data.stats.total_spent.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td><strong>Total de Litros:</strong></td>
                        <td>${data.stats.total_liters.toFixed(1)} L</td>
                    </tr>
                    <tr>
                        <td><strong>Consumo M茅dio:</strong></td>
                        <td>${data.stats.avg_consumption.toFixed(1)} km/L</td>
                    </tr>
                    <tr>
                        <td><strong>Abastecimentos:</strong></td>
                        <td>${data.stats.total_records_30d}</td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="alert alert-success mt-3">
            <i class="fas fa-check-circle me-2"></i>
            <strong>Preview carregado com sucesso!</strong> Os dados est茫o prontos para gerar o relat贸rio completo.
        </div>
    `;

    previewContent.innerHTML = html;
}

function showLoading(show, message = 'Gerando relat贸rio... Aguarde um momento.') {
    const loadingAlert = document.getElementById('loadingAlert');
    if (show) {
        loadingAlert.querySelector('span').textContent = message;
        loadingAlert.style.display = 'block';
    } else {
        loadingAlert.style.display = 'none';
    }
}

function showError(message) {
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');
    errorMessage.textContent = message;
    errorAlert.style.display = 'block';
}

function hideError() {
    document.getElementById('errorAlert').style.display = 'none';
}
</script>

<style>
.gradient-text {
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.card-header {
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px 15px 0 0 !important;
    border: none;
}

.btn-primary {
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.btn-primary:hover {
    background: linear-gradient(45deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-1px);
}

.alert {
    border-radius: 10px;
    border: none;
}

.table th, .table td {
    border-top: 1px solid rgba(255,255,255,0.1);
}
</style>
{% endblock %}