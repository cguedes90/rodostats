{% extends "base.html" %}

{% block title %}Perfil - FuelTracker Pro{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="gradient-text">
            <i class="fas fa-user me-2"></i>Meu Perfil
        </h1>
        <p class="text-muted">Gerencie suas informações pessoais</p>
    </div>
</div>

<div class="row">
    <!-- Informações do Perfil -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header text-center">
                <i class="fas fa-user-circle me-2"></i>Foto do Perfil
            </div>
            <div class="card-body text-center">
                <!-- Foto atual -->
                <div class="mb-3">
                    {% if current_user.profile_photo %}
                        <img src="{{ url_for('static', filename='uploads/' + current_user.profile_photo) }}" 
                             class="profile-photo" alt="Foto do perfil" id="currentPhoto">
                    {% elif current_user.oauth_photo %}
                        <img src="{{ current_user.oauth_photo }}" 
                             class="profile-photo" alt="Foto do perfil" id="currentPhoto">
                    {% else %}
                        <div class="profile-photo d-flex align-items-center justify-content-center" 
                             style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));"
                             id="currentPhoto">
                            <i class="fas fa-user fa-4x text-white"></i>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Upload de nova foto -->
                <form method="POST" action="{{ url_for('upload_profile_photo') }}" 
                      enctype="multipart/form-data" id="photoForm">
                    <div class="mb-3">
                        <input type="file" class="form-control" id="profile_photo" name="profile_photo" 
                               accept="image/*" style="display: none;">
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('profile_photo').click()">
                            <i class="fas fa-camera me-2"></i>Alterar Foto
                        </button>
                    </div>
                    
                    <!-- Preview da nova foto -->
                    <div id="photoPreview" style="display: none;">
                        <img id="previewImage" class="profile-photo mb-3" alt="Preview">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>Salvar Nova Foto
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="cancelPhotoUpload()">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </button>
                        </div>
                    </div>
                </form>
                
                <small class="text-muted">
                    Formatos aceitos: JPG, PNG<br>
                    Tamanho máximo: 2MB
                </small>
            </div>
        </div>
    </div>
    
    <!-- Dados Pessoais -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-id-card me-2"></i>Dados Pessoais
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Nome Completo</label>
                            <div class="form-control-plaintext fw-bold">
                                {{ current_user.name }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <div class="form-control-plaintext">
                                {{ current_user.email }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Método de Login</label>
                            <div class="form-control-plaintext">
                                {% if current_user.provider == 'local' %}
                                    <span class="badge bg-primary">
                                        <i class="fas fa-envelope me-1"></i>Email/Senha
                                    </span>
                                {% else %}
                                    <span class="badge bg-info">
                                        <i class="fas fa-code me-1"></i>{{ current_user.provider.title() }} Auth
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Membro desde</label>
                            <div class="form-control-plaintext">
                                {{ current_user.created_at.strftime('%d/%m/%Y às %H:%M') }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="d-grid gap-2 d-md-block">
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                        <i class="fas fa-edit me-2"></i>Editar Dados
                    </button>
                    {% if current_user.provider == 'local' %}
                        <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                            <i class="fas fa-key me-2"></i>Alterar Senha
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estatísticas do Usuário -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i>Suas Estatísticas
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="metric-value text-primary">{{ current_user.vehicles | length }}</div>
                        <div class="metric-label">Veículos Cadastrados</div>
                        <i class="fas fa-car fa-2x text-primary mt-2"></i>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-value text-success">{{ current_user.fuel_records | length }}</div>
                        <div class="metric-label">Abastecimentos</div>
                        <i class="fas fa-gas-pump fa-2x text-success mt-2"></i>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-value text-info">
                            R$ {{ "%.0f"|format(current_user.fuel_records | sum(attribute='total_cost')) }}
                        </div>
                        <div class="metric-label">Total Gasto</div>
                        <i class="fas fa-money-bill-wave fa-2x text-info mt-2"></i>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-value text-warning">
                            {{ "%.0f"|format(current_user.fuel_records | sum(attribute='liters')) }}L
                        </div>
                        <div class="metric-label">Total Litros</div>
                        <i class="fas fa-tint fa-2x text-warning mt-2"></i>
                    </div>
                </div>
                
                {% if current_user.fuel_records %}
                <hr>
                <div class="row text-center">
                    <div class="col-md-4">
                        <small class="text-muted">Primeiro Abastecimento</small>
                        <div class="fw-bold">
                            {{ current_user.fuel_records | min(attribute='fuel_date') | attr('fuel_date') | strftime('%d/%m/%Y') }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">Último Abastecimento</small>
                        <div class="fw-bold">
                            {{ current_user.fuel_records | max(attribute='fuel_date') | attr('fuel_date') | strftime('%d/%m/%Y') }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">Preço Médio/Litro</small>
                        <div class="fw-bold">
                            {% set total_cost = current_user.fuel_records | sum(attribute='total_cost') %}
                            {% set total_liters = current_user.fuel_records | sum(attribute='liters') %}
                            R$ {{ "%.3f"|format(total_cost / total_liters if total_liters > 0 else 0) }}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Perfil -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Editar Perfil
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('profile') }}">
                <div class="modal-body">
                    <div class="floating-label mb-3">
                        <input type="text" class="form-control" id="editName" name="name" 
                               value="{{ current_user.name }}" required>
                        <label for="editName">Nome Completo</label>
                    </div>
                    
                    <div class="floating-label mb-3">
                        <input type="email" class="form-control" id="editEmail" name="email" 
                               value="{{ current_user.email }}" required>
                        <label for="editEmail">Email</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Alterar Senha -->
{% if current_user.provider == 'local' %}
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-key me-2"></i>Alterar Senha
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('profile') }}" id="passwordForm">
                <div class="modal-body">
                    <div class="floating-label mb-3">
                        <input type="password" class="form-control" id="currentPassword" 
                               name="current_password" required>
                        <label for="currentPassword">Senha Atual</label>
                    </div>
                    
                    <div class="floating-label mb-3">
                        <input type="password" class="form-control" id="newPassword" 
                               name="new_password" required minlength="6">
                        <label for="newPassword">Nova Senha</label>
                    </div>
                    
                    <div class="floating-label mb-3">
                        <input type="password" class="form-control" id="confirmNewPassword" 
                               name="confirm_password" required>
                        <label for="confirmNewPassword">Confirmar Nova Senha</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-key me-2"></i>Alterar Senha
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Preview da foto
document.getElementById('profile_photo').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Validar tamanho
        if (file.size > 2 * 1024 * 1024) {
            alert('Arquivo muito grande! Máximo 2MB.');
            this.value = '';
            return;
        }
        
        // Validar tipo
        if (!file.type.match(/^image\/(jpeg|jpg|png)$/)) {
            alert('Formato inválido! Use JPG ou PNG.');
            this.value = '';
            return;
        }
        
        // Mostrar preview
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImage').src = e.target.result;
            document.getElementById('photoPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

function cancelPhotoUpload() {
    document.getElementById('profile_photo').value = '';
    document.getElementById('photoPreview').style.display = 'none';
}

// Validação da alteração de senha
{% if current_user.provider == 'local' %}
document.getElementById('passwordForm').addEventListener('submit', function(e) {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmNewPassword').value;
    
    if (newPassword !== confirmPassword) {
        e.preventDefault();
        alert('As senhas não coincidem!');
        return false;
    }
    
    if (newPassword.length < 6) {
        e.preventDefault();
        alert('A nova senha deve ter pelo menos 6 caracteres!');
        return false;
    }
});

// Verificação de força da senha em tempo real
document.getElementById('newPassword').addEventListener('input', function() {
    const password = this.value;
    const strength = calculatePasswordStrength(password);
    
    // Remove indicador existente
    const existingIndicator = this.parentNode.querySelector('.password-strength');
    if (existingIndicator) {
        existingIndicator.remove();
    }
    
    // Adiciona novo indicador
    if (password.length > 0) {
        const indicator = document.createElement('div');
        indicator.className = 'password-strength mt-1';
        indicator.innerHTML = `
            <small class="text-${strength.color}">
                <i class="fas fa-${strength.icon} me-1"></i>${strength.text}
            </small>
        `;
        this.parentNode.appendChild(indicator);
    }
});

function calculatePasswordStrength(password) {
    let score = 0;
    
    if (password.length >= 6) score++;
    if (password.length >= 8) score++;
    if (/[a-z]/.test(password)) score++;
    if (/[A-Z]/.test(password)) score++;
    if (/[0-9]/.test(password)) score++;
    if (/[^A-Za-z0-9]/.test(password)) score++;
    
    if (score < 3) {
        return { color: 'danger', icon: 'exclamation-triangle', text: 'Fraca' };
    } else if (score < 5) {
        return { color: 'warning', icon: 'shield-alt', text: 'Média' };
    } else {
        return { color: 'success', icon: 'check-circle', text: 'Forte' };
    }
}
{% endif %}

// Animação das estatísticas
document.addEventListener('DOMContentLoaded', function() {
    const metrics = document.querySelectorAll('.metric-value');
    
    metrics.forEach((metric, index) => {
        const value = metric.textContent;
        metric.textContent = '0';
        
        setTimeout(() => {
            animateNumber(metric, value, 1000);
        }, index * 200);
    });
});

function animateNumber(element, targetValue, duration) {
    const isMonetary = targetValue.includes('R$');
    const isLiters = targetValue.includes('L');
    const numericValue = parseFloat(targetValue.replace(/[^\d.-]/g, ''));
    
    if (isNaN(numericValue)) {
        element.textContent = targetValue;
        return;
    }
    
    const startTime = Date.now();
    const startValue = 0;
    
    function update() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        const currentValue = startValue + (numericValue - startValue) * easeOutCubic(progress);
        
        let displayValue;
        if (isMonetary) {
            displayValue = 'R$ ' + Math.round(currentValue);
        } else if (isLiters) {
            displayValue = Math.round(currentValue) + 'L';
        } else {
            displayValue = Math.round(currentValue).toString();
        }
        
        element.textContent = displayValue;
        
        if (progress < 1) {
            requestAnimationFrame(update);
        } else {
            element.textContent = targetValue;
        }
    }
    
    update();
}

function easeOutCubic(t) {
    return 1 - Math.pow(1 - t, 3);
}
</script>
{% endblock %}
